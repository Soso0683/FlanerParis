{% comment %}
  Section : Carrousel de vidéos (upload, loop, swipe, infini) + Titre & padding
  - FIX: boutons cliquables, init des vidéos y compris clones, anti-écran noir (fade-in quand prêt)
{% endcomment %}

<section id="vids-{{ section.id }}" class="vidsec"
  style="--pad-top: {{ section.settings.pad_top | default: 24 }}px; --pad-bottom: {{ section.settings.pad_bottom | default: 8 }}px;">
  {% if section.settings.heading != blank %}
    <h2 class="vidsec__title">{{ section.settings.heading }}</h2>
  {% endif %}

  <div class="vidsec__viewport">
    <button class="vidsec__btn vidsec__btn--prev" aria-label="Précédent" type="button">‹</button>

    <div class="vidsec__track">
      {%- for block in section.blocks -%}
        <div class="vidsec__item" {{ block.shopify_attributes }}>
          {% if block.settings.video != blank %}
            {{ block.settings.video
              | video_tag:
                class: 'vidsec__video',
                autoplay: true,
                muted: true,
                loop: true,
                playsinline: true,
                controls: false,
                preload: 'auto'
            | replace: '<video', '<video webkit-playsinline' }}
          {% elsif block.settings.mp4_url != blank %}
            <video class="vidsec__video"
                   src="{{ block.settings.mp4_url }}"
                   autoplay muted loop playsinline webkit-playsinline preload="auto"></video>
          {% else %}
            <div class="vidsec__placeholder">Video fehlt</div>
          {% endif %}
        </div>
      {%- endfor -%}
    </div>

    <button class="vidsec__btn vidsec__btn--next" aria-label="Suivant" type="button">›</button>
  </div>
</section>

<style>
  #vids-{{ section.id }}.vidsec{
    --gap:16px; --radius:16px;
    color:#111; font-family:inherit;
    padding-top: var(--pad-top);
    padding-bottom: var(--pad-bottom);
  }

  #vids-{{ section.id }} .vidsec__title{
    margin: 0 0 14px 0;
    text-align:center;
    font-family: inherit;
    font-weight: 800;
    letter-spacing: -0.02em;
    line-height: 1.15;
    font-size: clamp(28px, 5.6vw, 40px);
  }

  #vids-{{ section.id }} .vidsec__viewport{
    position:relative; overflow:hidden; width:100%;
    touch-action: pan-y;
  }
  #vids-{{ section.id }} .vidsec__track{
    --visible:3; /* desktop */
    display:flex; gap:var(--gap); align-items:stretch;
    transition:transform .5s ease; will-change:transform;
  }
  #vids-{{ section.id }} .vidsec__item{
    flex:0 0 calc((100% - (var(--gap) * (var(--visible) - 1))) / var(--visible));
    border-radius:var(--radius); overflow:hidden; background:#000;
  }

  /* Anti-écran noir : on ne montre la vidéo qu'une fois prête */
  #vids-{{ section.id }} .vidsec__video{
    width:100%; height:100%; display:block; object-fit:cover;
    pointer-events:none;
    opacity:0; transition: opacity .2s ease;
    background:#000;
  }
  #vids-{{ section.id }} .vidsec__video.is-ready{ opacity:1; }

  #vids-{{ section.id }} .vidsec__placeholder{
    height:220px; display:grid; place-items:center; color:#888; background:#f1f1f1;
  }
  #vids-{{ section.id }} .vidsec__btn{
    position:absolute; top:50%; transform:translateY(-50%);
    width:36px; height:36px; border-radius:50%; border:none;
    background:#111; color:#fff; opacity:.96; display:grid; place-items:center;
    cursor:pointer; z-index:10; /* plus haut que la piste */
  }
  #vids-{{ section.id }} .vidsec__btn--prev{ left:6px }
  #vids-{{ section.id }} .vidsec__btn--next{ right:6px }

  @media (max-width: 768px){
    #vids-{{ section.id }} .vidsec__track{ --visible:2; }
    #vids-{{ section.id }} .vidsec__btn{ width:32px; height:32px }
  }
</style>

<script>
(function(){
  const root  = document.getElementById('vids-{{ section.id }}'); if(!root) return;
  const track = root.querySelector('.vidsec__track');
  const prevB = root.querySelector('.vidsec__btn--prev');
  const nextB = root.querySelector('.vidsec__btn--next');

  let items   = Array.from(track.children);
  const orig  = items.length;
  if (orig === 0) return;

  const getVisible = () => parseInt(getComputedStyle(track).getPropertyValue('--visible')) || 3;
  const getStep = () => {
    const el = items[0]; if (!el) return 0;
    const cardW = el.getBoundingClientRect().width || 0;
    const gap   = parseFloat(getComputedStyle(track).gap) || 0;
    return cardW + gap;
  };

  /* ---------- CLONES pour boucle infinie ---------- */
  let cloneN = Math.min(getVisible(), orig);
  for(let i=orig-cloneN; i<orig; i++){ track.insertBefore(items[i].cloneNode(true), track.firstChild); }
  for(let i=0; i<cloneN; i++){ track.appendChild(items[i].cloneNode(true)); }
  items = Array.from(track.children);

  let index = cloneN;  // premier vrai
  let step  = 0;

  function ensureStep(){
    step = getStep();
    if (step <= 0) {
      const vpW = root.querySelector('.vidsec__viewport').clientWidth || 1;
      const vis = getVisible();
      step = (vpW / vis) + (parseFloat(getComputedStyle(track).gap) || 0);
    }
  }

  const go = (to, animate=true) => {
    ensureStep();
    index = to;
    track.style.transition = animate ? 'transform .5s ease' : 'none';
    track.style.transform  = `translateX(${-index * step}px)`;
  };

  track.addEventListener('transitionend', () => {
    if (index >= orig + cloneN){ go(index - orig, false); }
    else if (index < cloneN){    go(index + orig, false); }
  });

  /* ---------- BOUTONS : cliquables ---------- */
  nextB.addEventListener('click', (e)=>{ e.stopPropagation(); go(index + 1, true); });
  prevB.addEventListener('click', (e)=>{ e.stopPropagation(); go(index - 1, true); });

  /* ---------- Resize ---------- */
  const ro = new ResizeObserver(()=>{ ensureStep(); go(index, false); });
  ro.observe(root);
  window.addEventListener('load', ()=>{ ensureStep(); go(index, false); });

  /* ---------- Swipe ---------- */
  const vp = root.querySelector('.vidsec__viewport');
  let startX=0, delta=0, dragging=false;
  const start = (x, target) => {
    if (target && target.closest && target.closest('.vidsec__btn')) return; // ignorer si clic sur bouton
    dragging=true; startX=x; delta=0; track.style.transition='none';
  };
  const move  = x => { if(!dragging) return; ensureStep(); delta=x-startX; track.style.transform=`translateX(${-(index*step)+delta}px)`; };
  const end   = () => {
    if(!dragging) return; dragging=false; ensureStep();
    const thr = Math.max(40, step*0.18);
    if (delta >  thr) go(index-1, true);
    else if (delta < -thr) go(index+1, true);
    else go(index, true);
  };

  vp.addEventListener('pointerdown', e=>{ vp.setPointerCapture(e.pointerId); start(e.clientX, e.target); });
  vp.addEventListener('pointermove', e=> move(e.clientX));
  vp.addEventListener('pointerup', end);
  vp.addEventListener('pointercancel', end);
  vp.addEventListener('touchstart', e=> start(e.touches[0].clientX, e.target), {passive:true});
  vp.addEventListener('touchmove',  e=> move(e.touches[0].clientX), {passive:true});
  vp.addEventListener('touchend', end);

  /* ---------- VIDÉOS : init + anti-écran noir ---------- */
  function initOneVideo(v){
    if (v.dataset.init === '1') return;
    v.dataset.init = '1';
    v.muted = true; v.loop = true; v.playsInline = true;
    v.addEventListener('loadeddata', ()=>{ v.classList.add('is-ready'); }, { once:true });
    // tenter le play quand possible
    const tryPlay = ()=> { try { v.play().catch(()=>{}); } catch(e){} };
    v.addEventListener('canplay', tryPlay, { once:true });
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) tryPlay(); });
  }

  function initAllVideos(){
    const vids = Array.from(root.querySelectorAll('video'));
    vids.forEach(initOneVideo);

    // Observer visibilité (joue/pause selon visibilité)
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        const v = entry.target;
        if (entry.isIntersecting && entry.intersectionRatio > 0.55){
          try { v.play().catch(()=>{}); } catch(e){}
        } else {
          try { v.pause(); } catch(e){}
        }
      });
    }, { root: vp, threshold: [0, .55, 1] });

    vids.forEach(v=> io.observe(v));
  }

  initAllVideos();    // init originaux
  go(index, false);   // position initiale
})();
</script>

{% schema %}
{
  "name": "Vidéos (upload + titre)",
  "settings": [
    { "type": "text", "id": "heading", "label": "Titre", "default": "Konkrete Ergebnisse" },
    { "type": "range", "id": "pad_top", "label": "Padding haut (px)", "min": 0, "max": 80, "step": 2, "default": 24 },
    { "type": "range", "id": "pad_bottom", "label": "Padding bas (px)", "min": 0, "max": 80, "step": 2, "default": 8 }
  ],
  "blocks": [
    {
      "type": "clip",
      "name": "Vidéo",
      "settings": [
        { "type": "video", "id": "video", "label": "Vidéo (téléversée sur Shopify)" },
        { "type": "url", "id": "mp4_url", "label": "OU URL .mp4 (fallback)" }
      ]
    }
  ],
  "max_blocks": 12,
  "presets": [
    { "name": "Vidéos + Titre", "blocks": [{ "type": "clip" }, { "type": "clip" }, { "type": "clip" }, { "type": "clip" }] }
  ]
}
{% endschema %}
